#  Django国际化`i18n`流程

本指南详细记录了为 Django 项目添加多语言支持（本文以中日双语为例）的完整流程，从配置、标记、翻译到部署。

## *第一步：项目配置 (`settings.py`)*

这是所有工作的基础，告诉 Django 项目要支持国际化，参考如下代码

### 核心配置

- 导入如下模块

  ```python
  # 这俩是国际化导入包
  from django.utils.translation import gettext_lazy as _
  import os
  ```

- 确保中间件已添加，且位于正确的位置

  ```python
  MIDDLEWARE = [
      'django.middleware.security.SecurityMiddleware',
      'django.contrib.sessions.middleware.SessionMiddleware',
      'django.middleware.locale.LocaleMiddleware',  # <-- 关键！必须在 SessionMiddleware 之后，CommonMiddleware 之前
      'django.middleware.common.CommonMiddleware',
      # ... 其他中间件
  ]
  ```

- 确认模板中已经启用`i18n`

  ```python
  TEMPLATES = [
      {
          # ...
          'OPTIONS': {
              'context_processors': [
                  # ...
                  'django.template.context_processors.i18n', # <-- 确保此项存在
              ],
          },
      },
  ]
  ```

- 国际化核心设置，注意这里的`local`文件夹必须是创建在manage同级目录下才可以

  ```python
  # 默认语言
  LANGUAGE_CODE = 'zh-hans'# 这个一般默认会已经存在
  # 支持的语言列表（语言代码，显示名称）
  LANGUAGES = [
      ('zh-hans', _('简体中文')),
      ('ja', _('日本語')),
  ]
  # 翻译文件所在目录（通常设在项目根目录，即 manage.py 同级目录）
  LOCALE_PATHS = [
      os.path.join(BASE_DIR, 'locale'),
  ]
  # 启用国际化与本地化
  USE_I18N = True
  USE_L10N = True
  ```

### URL 配置 (`urls.py`)

- 导入如下包

  ```python
  from django.urls import path,include
  from django.views.i18n import set_language
  ```

- 添加如下路径

  ```python
  urlpatterns = [
      # ... 其他 URL 模式
      path('i18n/', include('django.conf.urls.i18n')), # 提供 /i18n/setlang/ 端点
  ]
  ```

***

## 第二步：标记可翻译文本

### 1. 在 Python 代码中（模型、视图、表单）

**使用 `gettext_lazy` (用于在模块加载时翻译的值，如 verbose_name) 和 `gettext` (用于在视图或函数中翻译的值)。**采用`_()`的形式标记需要翻译的内容

```python
# models.py
from django.utils.translation import gettext_lazy as _

class Student(models.Model):
    name = models.CharField(_('姓名'), max_length=100) # 字段标签
    age = models.IntegerField(_('年龄'))

    class Meta:
        verbose_name = _('学生')
        verbose_name_plural = _('学生们')

# forms.py
from django.utils.translation import gettext_lazy as _

class StudentForm(forms.ModelForm):
    class Meta:
        model = Student
        fields = '__all__'
        labels = {
            'name': _('姓名'),
        }
        help_texts = {
            'name': _('请输入学生的全名。'),
        }
        error_messages = {
            'name': {
                'required': _('必须填写姓名'),
            }
        }

# views.py
from django.utils.translation import gettext as _
from django.contrib import messages

def my_view(request):
    messages.success(request, _('操作成功！'))
    title = _('学生列表')
    return render(request, 'template.html', {'title': title})
```

### 2. 在 HTML 模板中

**首先加载 `i18n` 标签库。采用`{% trans '待翻译文本' %}`的形式标记**

```html
<!-- 在模板最顶部附近加载 -->
{% load i18n %}
<!-- 1. 翻译简单字符串 -->
<title>{% trans "学生管理系统" %}</title>
<h1>{% trans "学生列表" %}</h1>
<option value="">{% trans "请选择" %}</option>

<!-- 2. 翻译带有变量的复杂字符串 -->
<p>
    {% blocktrans count counter=student_count %}
        这里有 {{ counter }} 个学生。
    {% plural %}
        这里有 {{ counter }} 个学生们。
    {% endblocktrans %}
</p>

<!-- 3. 翻译模板中的变量（如表单错误） -->
{% if form.errors %}
    {% for error in form.non_field_errors %}
        <p>{% trans error %}</p> <!-- 假设 error 已经是可翻译字符串 -->
    {% endfor %}
{% endif %}

<!--  placeholder 等属性也需要翻译 -->
<input type="text" placeholder='{% trans "搜索学生..." %}'>
```

***

## 第三步：创建与编辑翻译文件

### 1. 安装 `Gettext`工具 (Windows)

- 下载: https://mlocati.github.io/articles/gettext-iconv-windows.html
- 解压并将 `bin` 目录（如 `C:\gettext\bin`）添加到系统 `PATH` 环境变量。
- 重启终端，运行 `gettext --version` 验证。

### 2. 生成消息文件 (.po)

**在包含 `manage.py` 的项目根目录下运行(`pycharm`控制台)：**

```python
# 为日语创建翻译文件
django-admin makemessages -l ja
# 为简体中文创建翻译文件 (如果原始代码不是中文)
# django-admin makemessages -l zh_Hans

# 如果遇到 locale 路径错误，请检查 settings.py 中的 LOCALE_PATHS 或手动创建 locale 文件夹。
```

-  这条命令会扫描整个项目，找到被`_()`以及`{% trans ''%}`和`{% blocktrans %}`所标记的文本
- 生成`.po`文件，位于`local/目标语言(ja)/LC_MESSAGES/django.po`

### 3. 编辑 .po 文件

用文本编辑器打开 `django.po` 文件，填写 `msgstr ""`。

```python
#: .\students\models.py:10
msgid "Name"
msgstr "名前" # 日文翻译

#: .\students\templates\base.html:5
msgid "Student Management System"
msgstr "学生管理システム" # 日文翻译

#: .\settings.py:148
msgid "Simplified Chinese"
msgstr "簡体字中国語" # 语言名称本身也需要翻译！
msgid "Japanese"
msgstr "日本語"
```

- **`msgid`**: 源代码中的字符串。
- **`msgstr`**: 翻译后的字符串。
- 对于中文项目，如果 `msgid` 已是中文，`msgstr` 通常填写相同内容即可。

### 4. 编译消息文件 (`.mo`)

**编辑完成后，编译` .po` 文件为二进制` .mo `文件，Django 运行时使用。**

```python
django-admin compilemessages
```

- 成功后，会在每个 `LC_MESSAGES` 目录下生成一个 `django.mo` 文件。



***

## 第四步：添加前端语言切换功能

在模板（如 `base.html`）中添加一个表单，让用户可以选择语言。可以结合诸如bootstrap令其变得更加美观

```html
{% load i18n %}

<form action="{% url 'set_language' %}" method="post" class="form-inline">
    {% csrf_token %}
    <input name="next" type="hidden" value="{{ request.get_full_path }}">
    <select name="language" class="form-control input-sm" onchange="this.form.submit()">
        {% get_current_language as LANGUAGE_CODE %}
        {% get_available_languages as LANGUAGES %}
        {% get_language_info_list for LANGUAGES as languages %}
        {% for language in languages %}
            <option value="{{ language.code }}" {% if language.code == LANGUAGE_CODE %} selected {% endif %}>
                {{ language.name_local }} ({{ language.code }})
            </option>
        {% endfor %}
    </select>
    <noscript>
        <input type="submit" class="btn btn-default btn-sm" value="{% trans 'Switch' %}">
    </noscript>
</form>
```

- Django 的 `set_language` 视图会处理表单提交，将用户选择的语言偏好存储在 session 或 cookie 中。
- `LocaleMiddleware` 会为每个请求据此设置语言。



***

## 第五步：测试与部署

### 测试

1. **开发服务器测试**: 运行 `python manage.py runserver`。
2. **切换浏览器语言**（测试中间件检测）:
   - Chrome: 设置 -> 高级 -> 语言 -> 添加语言并拖到顶部。
3. **使用页面上的切换器**（测试表单功能）。

### 部署 (PythonAnywhere 或其他平台)

1. **确保翻译文件被上传**: `locale/` 目录及其下的 `.mo` 文件必须包含在部署文件中。
2. **可能需要在部署后重新编译**: 在某些环境下，需要在生产服务器上再次运行 `compilemessages`。
3. **设置生产环境的语言设置**: 确保 `settings.py` 中的配置适用于生产。



***

## 常见问题 & 技巧

- **Windows Gettext**: 确保安装正确并已添加到 `PATH`。
- **Locale路径**: 确保 `settings.py` 中的 `LOCALE_PATHS` 指向正确且已存在的目录。
- **中间件顺序**: `LocaleMiddleware` 必须在 `SessionMiddleware` 之后。
- **新增翻译**: 每次添加新的可翻译字符串后，都需要重新运行 `makemessages` 和 `compilemessages`。
- **Bootstrap兼容**: 只翻译文本内容，不要翻译 CSS 类名 (`class="btn btn-primary"`)。
- **`.mo` 文件未更新**: 编译后如果翻译不生效，尝试重启开发服务器，因为 `.mo` 文件可能会被缓存。



***

## 总结流程

1. **配置** (`settings.py`, `urls.py`) ->
2. **标记** (代码用 `gettext`, 模板用 `{% trans %}`) ->
3. **生成** (`makemessages`) ->
4. **翻译** (编辑 `.po` 文件) ->
5. **编译** (`compilemessages`) ->
6. **切换** (添加前端表单) ->
7. **测试与部署**。

